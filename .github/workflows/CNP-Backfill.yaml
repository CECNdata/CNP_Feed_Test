name: 'CNP-Backfill'

on:
  workflow_dispatch:
  #schedule:
   # - cron: '0 18,13 * * *'

env:
  repo_name: CECNdata/GA-sec
  retry: 2
  cncc_url: http://stats.customs.gov.cn/queryDataForEN/queryDataListEn
  docker_image: ghcr.io/cecndata/ga-sec:latest
  path: CNP-Customs-Test/mapping/CNP-Backfill.csv
  dl_path: firefox-dl/run_history_all.py
  timeout: 1200

jobs:
  download:
    runs-on: ubuntu-latest
    strategy:
      matrix:
       include:
         - line: 0
         - line: 1
         - line: 2
         - line: 3
         - line: 4
         - line: 5
         - line: 6
         - line: 7
         - line: 8
         - line: 9
         - line: 10
         - line: 11
         - line: 12
         - line: 13
         - line: 14
         - line: 15          
           
    steps:
      - name: Checkout codes
        uses: actions/checkout@v3
        with:
          repository: '${{ env.repo_name  }}'
          token: ${{ secrets.GH_PAT }} # `GH_PAT` is a secret that contains you PAT
          ref: main

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_PAT }}
      - name: Get Docker image digest
        id: docker-digest
        run: |
          DIGEST=$(docker manifest inspect ${{ env.docker_image }} --verbose | jq -r '.Descriptor.digest')
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
      - uses: actions/cache@v3
        id: docker-cache
        with:
          path: /tmp/ga-sec_latest.tar
          key: ga-sec-latest-${{ steps.docker-digest.outputs.digest }}
          restore-keys: |
            ga-sec-latest-
      - if: steps.docker-cache.outputs.cache-hit != 'true'
        run: |
            docker pull ${{ env.docker_image }}
            docker save ${{ env.docker_image }} -o /tmp/ga-sec_latest.tar
      - if: steps.docker-cache.outputs.cache-hit == 'true'
        run: docker load -i /tmp/ga-sec_latest.tar
      - name: Export all GitHub env to Docker env file
        run: |
          env > /tmp/github_env.list

      - name: Run customs download in Docker
        continue-on-error: true
        run: |
          docker run --rm \
            --env-file /tmp/github_env.list \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace/feed \
            ${{ env.docker_image }} \
            timeout ${{env.timeout}}  xvfb-run python ${{ env.dl_path}} \
            --path ${{ env.path }} \
            --line "${{ matrix.line }}" \
            --retry ${{ env.retry }}           
